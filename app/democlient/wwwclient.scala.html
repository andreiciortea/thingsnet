<html>
    <head>
        <link rel="stylesheet" type="text/css" href="/assets/stylesheets/wwwclient.css">
        <script src="/assets/javascripts/jquery-1.11.1.min.js"></script>
        
        <title>STN Browser</title>
    </head>
    
    <body>
        <h1>STN Browser</h1>
        
        <div><strong>Client WebID</strong>: <input id="client_webid" type="text" size="50" value="http://www.example.com/#thing" /></div>
        <div><strong>Owner's WebID</strong>: <input id="client_owner" type="text" size="50" value="http://www.andreiciortea.ro/#me" /></div>
        <div><strong>Displayed Name</strong>: <input id="client_displayedName" type="text" size="50" value="STN Client" /></div>
        <div><strong>Description</strong>: <input id="client_description" type="text" size="50" value = "I am a demo client for the WoT 2014 workshop." /></div>
        
        <div class="main">
        
            <div class="list">
            
                <div class="list-header">
                    <div class="list-left">Name:</div>
                    <div class="list-center">URI:</div>
                    <div>Available operations:</div>
                </div>
                
                <div id="stnlist" class="list-content">
                
                </div>
                
                <div class="list-footer">
                    <label for="stndescdoc">STN description document URL:</label>
                    <input id="stndescdoc" size="50"></input>
                    <button id="addstn">Add STN!</button>
                </div>
                
            </div>
            
            <div class="details">
                <div class="list-header">Operation details:</div>
                
                <div id="op-stn-index" style="display: none;"></div>
                <div id="op-index" style="display: none;"></div>
                
                <div><label class="details-left">Operation: </label><div id="op-uri" class="details-right"></div></div>
                <div style="clear: both;"></div>
                <div><label class="details-left">Class: </label><div id="op-class" class="details-right"></div></div>
                <div style="clear: both;"></div>
                <div><label class="details-left">Base URL: </label><div id="op-base-url" class="details-right"></div></div>
                <div style="clear: both;"></div>
                <div><label class="details-left">Method: </label><div id="op-method" class="details-right"></div></div>
                <div style="clear: both;"></div>
                <div><label class="details-left">Request URI: </label><div id="op-request-uri" class="details-right"></div></div>
                <div style="clear: both;"></div>
                <div>
                    <label>Parameters:</label>
                    <div id="op-params"></div>
                </div>
                
                <div class="details-footer">
                    <button id="runop">Run operation!</button>
                </div>
            </div>
            
        </div>
        
        <div id="debug" style="clear: both;">
            <textarea id="output" readonly="readonly" rows="25"></textarea>
        </div>

        <script>
            var STN = [];
            var stnIndex = 0;

            // Generates the select options from a JSON array of operations.            
            function inflateOpOptions(jsonData) {
                var options = "";
                $.each(jsonData, function(index, op) {
                  options += '<option value="' + index + '">' + op['cls'] + '</option>';
                });
                
                return options;
            }
            
            // Adds an STN from a JSON spec.
            function addSTN(jsonData) {
                // Add JSON data to STN index.
                STN[stnIndex ++] = jsonData;
                
                // Add STN to the list of platforms.
                return '<div class="list-row">' +
                    '<div class="list-left">' + jsonData['name'] + '</div>' +
                    '<div class="list-center">' + jsonData['uri'] + '</div>' +
                    '<select id="' + (stnIndex - 1) + '" class="list-right" onchange="showOpDetails(' + (stnIndex-1) + ')">' +
                        '<option selected disabled>Select Command</option>' +
                        inflateOpOptions(jsonData['operations']) +
                    '</select>' +
                '</div>' ;
            }
            
            // Display the details of a selected operation.
            function showOpDetails(index) {
                opIndex = $("#" + index).val();
                op = STN[index]['operations'][opIndex]
                
                $("#op-stn-index").text( index );
                $("#op-index").text( opIndex );
                $("#op-uri").text( op['id'] );
                $("#op-class").text( op['cls'] );
                $("#op-base-url").text( STN[index]['baseUrl'] );
                $("#op-method").text( op['method'] );
                $("#op-request-uri").text( op['requestUri'] );

                var kb = { "http://purl.org/stn/operations#MyWebID": $('#client_webid').val(),
                        "http://purl.org/stn/operations#MyOwnerID": $('#client_owner').val(),
                        "http://purl.org/stn/operations#MyDisplayedName": $('#client_displayedName').val(),
                        "http://purl.org/stn/operations#MyDescription": $('#client_description').val()
                    }
                
                var paramStr = "<div>";
                $.each(op['params'], function(i, param) {
                    paramStr += '<div><div>' + param["cls"] + ' (required)</div>';
                    paramStr += '<div>Name: ' + param["name"] + '</div>';
                    paramStr += 'Value: <input id="param-' + i + '" value="' + ((kb[param["cls"]] == undefined) ? "" : kb[param["cls"]]) + '" size="40" />';
                    paramStr += '</div>';
                });
                paramStr += "</div>";
                
                $("#op-params").html( paramStr );
            }
            
            // Checks an operation URI for inline parameters.
            function parseOpURI(uri, params) {
                if (uri.indexOf(':') > -1) {
                    $.each(params, function(i, param) {
                        if (param['name'].charAt(0) == ':' && uri.indexOf(param['name']) > -1) {
                            alert("replacing param!");
                            uri = uri.replace(new RegExp(param['name'], 'g'), $("#param-" + i).val());
                        }
                    });
                }
                
                return uri;
            }
            
            // Wraps up all data necessary for running an operation.
            function getOpData() {
                var data = {};
                
                index = $("#op-stn-index").text();
                opIndex = $("#op-index").text();
                op = STN[index]['operations'][opIndex];
                
                data['mywebid'] = $("#client_webid").val();
                data['method'] = $("#op-method").text();
                data['requestUri'] = parseOpURI($("#op-base-url").text() + $("#op-request-uri").text(), op['params']);
                data['jsonData'] = packOpParams(op['params']);
                
                return data;
            }
            
            // Returns a json string with all params.
            function packOpParams(params) {
                var data = {};
                $.each(params, function(i, param) {
                    if (param["name"].charAt(0) != ':') {
                        data[param["name"]] = $("#param-" + i).val();
                    }
                });
                
                return JSON.stringify(data);
            }
            
            function fetchAddSTN(stnDescURI) {
                $.get("/wwwclient/stn-spec", { uri: encodeURIComponent(stnDescURI) }, function(data, status) {
                    $("#debug").append( JSON.stringify(data) );
                    $("#stnlist").append(addSTN(data));
                });
            }
            
            $(document).ready(function() {
              fetchAddSTN("http://localhost:9000/assets/stnspec.ttl");
              fetchAddSTN("http://localhost:9000/assets/twitter/stnspec.ttl");
            
              $("#addstn").click(function() {
                fetchAddSTN( $("#stndescdoc").val() );
              });
              
              $("#runop").click(function() {
                $.post("/client/run", getOpData(), function(data, status) {
                    //$("#debug").text( data );
                    $("#output").text( data );
                });
              });
            });
            
        </script>
        
    </body>
</html>